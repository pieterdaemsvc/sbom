name: docker_build_container
run-name: docker build üèóÔ∏è
on:
  push:
    paths:
      - example_docker/**
      - .github/workflows/sbom.yml
  workflow_dispatch:
env:
# defines environment variables that are available to all jobs in the workflow
  APP_IMAGE: ghcr.io/${{ github.repository }}/example-docker
  APP_COMMIT_SHA: "${{ github.event.pull_request.head.sha || github.sha }}"
jobs:
  container:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Require write permission to Fetch an federated identity token.
      contents: read # Require read permission to access the repository contents.
      packages: write # Require write permission to publish docker image to package.
    steps:
        - name: git clone application code
          uses: actions/checkout@v4

        - name: docker login github packages
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: volvo-cars
            password: ${{ secrets.GITHUB_TOKEN}}
        

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
          with:
            cache-binary: true
           
        - name: Docker meta
          id: meta
          uses: docker/metadata-action@v5.6.1
          with:
            # list of Docker images to use as base name for tags
            images: |
                ${{ env.APP_IMAGE}}
            # generate Docker tags based on the following events/attributes
            tags: |
                type=raw,value=${{ github.sha }}
                type=raw,value=latest
          env:
            DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest
        - name: Build and push
          id: docker_build
          uses: docker/build-push-action@v6
          with:
            platforms: linux/amd64
            context: ./example_docker
            file: ./example_docker/Dockerfile
            push: true
            load: false
            tags: ${{ steps.meta.outputs.tags }}
            annotations: ${{ steps.meta.outputs.annotations }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=gha,mode=max,timeout=${{ env.CACHE_TIMEOUT}}
            cache-to: type=gha,mode=max,ignore-error=true,timeout=${{ env.CACHE_TIMEOUT}}
            provenance: mode=max
            sbom: true
          env: #https://github.com/marketplace/actions/build-and-push-docker-images#environment-variables
            DOCKER_BUILD_CHECKS_ANNOTATIONS: "true"
            DOCKER_BUILD_SUMMARY: "true"
            DOCKER_BUILD_RECORD_UPLOAD: "true"
            CACHE_TIMEOUT: 10m
        

        - uses: anchore/sbom-action/publish-sbom@v0
          with:
              sbom-artifact-match: ".*\\.spdx$"